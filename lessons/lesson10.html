<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L10: Building a Shape</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Specific CSS for the grid layout */
        .drawing-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            width: 180px;
            height: 180px;
            margin: 20px auto;
            border: 1px solid #ccc;
        }
        .grid-cell {
            width: 60px;
            height: 60px;
            background: #fff;
            border: 1px solid #eee;
            box-sizing: border-box;
            font-size: 0.8rem;
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .grid-cell.filled { 
            background-color: var(--color-primary); 
            transition: background-color 0.3s;
        }
        .game-area .game-button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <header class="academy-header">
        <h1>Lesson 10: Building a Shape</h1>
        <p><a href="../index.html" style="color: var(--color-accent);">‚Üê Back to Course Index</a></p>
    </header>

    <div class="lesson-page-container">
        <p><strong>Goal:</strong> Use **Nested Logic** (Sequences inside of Loops) to draw a **2x2 blue square**! You must fill cells **(1,1), (1,2), (2,1), and (2,2)**.</p>
        
        <div class="game-area">
            <h3 style="color: var(--color-primary);">The Canvas:</h3>
            <div class="drawing-grid" id="drawing-grid">
                <div class="grid-cell" data-row="0" data-col="0"></div>
                <div class="grid-cell" data-row="0" data-col="1"></div>
                <div class="grid-cell" data-row="0" data-col="2"></div>

                <div class="grid-cell" data-row="1" data-col="0"></div>
                <div class="grid-cell" data-row="1" data-col="1"></div>
                <div class="grid-cell" data-row="1" data-col="2"></div>

                <div class="grid-cell" data-row="2" data-col="0"></div>
                <div class="grid-cell" data-row="2" data-col="1"></div>
                <div class="grid-cell" data-row="2" data-col="2"></div>
            </div>
            
            <p><strong>Instructions:</strong> The robot ü§ñ starts at **(1,1)**. Follow the pattern: **(Fill, Move Right, Fill, Move Down, Move Left, Fill, Move Right, Fill)**</p>
            
            <button id="fill-cell-btn" class="game-button">Fill Cell üé®</button>
            <button id="move-right-btn" class="game-button">Move Right ‚Üí</button>
            <button id="move-down-btn" class="game-button">Move Down ‚Üì</button>
            <button id="move-left-btn" class="game-button">Move Left ‚Üê</button>
            <button id="reset-btn" class="game-button" style="background-color: #E74C3C;">Reset</button>

            <div class="game-feedback" id="game-feedback">Current Position: (1,1). Follow the instruction sequence above!</div>
        </div>
        
        <a href="#" id="next-btn" class="game-button hidden">Next Lesson ‚Üí</a>
    </div>

    <script src="../js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initializeLesson(10); 
            
            const feedback = document.getElementById('game-feedback');
            const gridCells = document.querySelectorAll('.grid-cell');
            
            // Start position is (1, 1), the first cell of the 2x2 square
            let robotPosition = { row: 1, col: 1 };
            const drawnCells = new Set();
            // The four cells that must be filled
            const targetCells = new Set(['1,1', '1,2', '2,1', '2,2']);
            
            const fillBtn = document.getElementById('fill-cell-btn');
            const moveRightBtn = document.getElementById('move-right-btn');
            const moveDownBtn = document.getElementById('move-down-btn');
            const moveLeftBtn = document.getElementById('move-left-btn');


            function updateRobotPosition() {
                // Clear robot emoji from all cells
                gridCells.forEach(cell => cell.innerHTML = '');
                
                const key = `${robotPosition.row},${robotPosition.col}`;
                // Select the current cell using data attributes
                const currentCell = document.querySelector(`.grid-cell[data-row="${robotPosition.row}"][data-col="${robotPosition.col}"]`);
                
                if (currentCell) {
                    currentCell.innerHTML = 'ü§ñ'; // Place robot emoji
                }
                feedback.innerText = `Current Position: (${key}).`;
                checkCompletion();
            }

            function fillCell() {
                const key = `${robotPosition.row},${robotPosition.col}`;
                const currentCell = document.querySelector(`.grid-cell[data-row="${robotPosition.row}"][data-col="${robotPosition.col}"]`);
                
                if (!currentCell) return; // Should not happen

                if (targetCells.has(key)) {
                    // Check if it's a target cell
                    if (!drawnCells.has(key)) {
                        // Only fill if it hasn't been filled already
                        currentCell.classList.add('filled');
                        drawnCells.add(key);
                        feedback.innerText = `Filled cell (${key})!`;
                    } else {
                        feedback.innerText = `Cell (${key}) is already filled! Move to a new spot.`;
                    }
                } else {
                    // If the cell is outside the target 2x2 area
                    feedback.innerText = `‚ö†Ô∏è Mistake! You filled cell (${key}). This is outside the target 2x2 square. Starting over!`;
                    resetPuzzle(); // Force reset on error
                    return;
                }
                updateRobotPosition();
            }

            function move(dr, dc) {
                // Calculate new position
                const newRow = robotPosition.row + dr;
                const newCol = robotPosition.col + dc;
                
                // Bounds check: Must stay within the 2x2 drawing area (rows 1-2, columns 1-2)
                if (newRow >= 1 && newRow <= 2 && newCol >= 1 && newCol <= 2) {
                    robotPosition = { row: newRow, col: newCol };
                } else {
                    feedback.innerText = "‚ö†Ô∏è Oops! You tried to move outside the 2x2 drawing area. Try again!";
                    resetPuzzle(); // Force reset on error
                    return;
                }
                updateRobotPosition();
            }
            
            function resetPuzzle() {
                robotPosition = { row: 1, col: 1 }; // Reset to (1,1)
                drawnCells.clear();
                gridCells.forEach(cell => cell.classList.remove('filled'));
                // Re-enable buttons
                fillBtn.disabled = false;
                moveRightBtn.disabled = false;
                moveDownBtn.disabled = false;
                moveLeftBtn.disabled = false;
                updateRobotPosition();
                feedback.innerText = "Puzzle reset! Start drawing the 2x2 square from (1,1).";
            }

            function checkCompletion() {
                // The puzzle is complete if:
                // 1. All four target cells are in the drawnCells set.
                // 2. ONLY four cells have been drawn (to prevent drawing extras outside the target).
                const allRequiredFilled = Array.from(targetCells).every(key => drawnCells.has(key));
                const correctTotal = drawnCells.size === 4;

                if (allRequiredFilled && correctTotal) {
                    feedback.innerText = "üéâ PERFECT! You combined logic to build the shape and completed the Intermediate track!";
                    // Disable all interaction buttons
                    fillBtn.disabled = true;
                    moveRightBtn.disabled = true;
                    moveDownBtn.disabled = true;
                    moveLeftBtn.disabled = true;
                    window.lessonSuccess(); // Mark lesson as complete
                }
            }
            
            // Attach event listeners to buttons
            fillBtn.onclick = fillCell;
            moveRightBtn.onclick = () => move(0, 1);
            moveDownBtn.onclick = () => move(1, 0);
            moveLeftBtn.onclick = () => move(0, -1);
            document.getElementById('reset-btn').onclick = resetPuzzle;

            // Initial setup
            updateRobotPosition();
        });
    </script>
</body>
</html>
